package kr.co.ibk.itep.service;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import kr.co.ibk.itep.dao.Dao;
import kr.co.ibk.itep.dto.Emp001m;
import kr.co.ibk.itep.dto.EmpJoinedDep;

@Component
public class ServiceImpl implements Service {
	private static final Logger logger = LoggerFactory.getLogger(ServiceImpl.class);
	@Autowired
	private Dao dao;

	@Override
	public EmpJoinedDep ssoLogin(String emn) {
		// TODO Auto-generated method stub
		String fullEmn = "0" + emn;
		EmpJoinedDep empJoinedDep = dao.selectByEmn(fullEmn);

		return empJoinedDep;
	}

	@Transactional(isolation=Isolation.READ_UNCOMMITTED)
	@Override
	public void fileUploader(File f) {

		try {
			BufferedReader in = new BufferedReader(new FileReader(f));
			String s;
			Emp001m emp001m = new Emp001m();
			ArrayList<Emp001m> list = new ArrayList<>();

			while ((s = in.readLine()) != null) {

				emp001m.setEmn(s.substring(0, 6));
				emp001m.setEmm(s.substring(6, 56));
				emp001m.setBlng_brcd(s.substring(56, 60));
				emp001m.setAuth_cd(s.substring(60, 62));
				;
				emp001m.setReg_id(s.substring(62, 68));
				emp001m.setReg_dt(s.substring(68, 76));
				emp001m.setChg_id(s.substring(76, 82));
				emp001m.setChg_dt(s.substring(82, 90));

				emp001m.setEmm(emp001m.getEmm().trim());

				logger.info(emp001m.getEmn() + "," + emp001m.getEmm() + "," + emp001m.getBlng_brcd() + ","
						+ emp001m.getAuth_cd() + "," + emp001m.getReg_id() + "," + emp001m.getReg_dt() + ","
						+ emp001m.getChg_id() + "," + emp001m.getChg_dt());

				list.add(emp001m);

				Map<String, Object> map = new HashMap<>();
				map.put("list", list);

				dao.deleteAllEmp();
				dao.insertAllEmp(map);
			}
			in.close();
		} catch (IOException e) {
			System.err.println(e);
		}
	}

}
